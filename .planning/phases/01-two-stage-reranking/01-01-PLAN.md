---
phase: 01-two-stage-reranking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agent-brain-server/agent_brain_server/config/settings.py
  - agent-brain-server/agent_brain_server/config/provider_config.py
  - agent-brain-server/agent_brain_server/providers/base.py
autonomous: true

must_haves:
  truths:
    - "Reranking is disabled by default (ENABLE_RERANKING=false)"
    - "User can enable reranking via environment variable"
    - "Reranker configuration follows existing provider pattern"
  artifacts:
    - path: "agent-brain-server/agent_brain_server/config/settings.py"
      provides: "ENABLE_RERANKING, RERANKER_* settings"
      contains: "ENABLE_RERANKING"
    - path: "agent-brain-server/agent_brain_server/config/provider_config.py"
      provides: "RerankerConfig class"
      contains: "class RerankerConfig"
    - path: "agent-brain-server/agent_brain_server/providers/base.py"
      provides: "RerankerProviderType enum"
      contains: "class RerankerProviderType"
  key_links:
    - from: "config/provider_config.py"
      to: "providers/base.py"
      via: "RerankerProviderType import"
      pattern: "from.*providers.base.*import.*RerankerProviderType"
---

<objective>
Add configuration settings and types for the two-stage reranking feature.

Purpose: Enable users to configure reranking via environment variables and YAML config, following existing provider patterns.
Output: Settings, config class, and provider type enum for reranking.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-two-stage-reranking/01-RESEARCH.md
@agent-brain-server/agent_brain_server/config/settings.py
@agent-brain-server/agent_brain_server/config/provider_config.py
@agent-brain-server/agent_brain_server/providers/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reranking settings to Settings class</name>
  <files>agent-brain-server/agent_brain_server/config/settings.py</files>
  <action>
Add these settings to the Settings class after the GraphRAG configuration section:

```python
# Reranking Configuration (Feature 123)
ENABLE_RERANKING: bool = False  # Off by default
RERANKER_PROVIDER: str = "sentence-transformers"  # or "ollama"
RERANKER_MODEL: str = "cross-encoder/ms-marco-MiniLM-L-6-v2"
RERANKER_TOP_K_MULTIPLIER: int = 10  # Retrieve top_k * this for Stage 1
RERANKER_MAX_CANDIDATES: int = 100  # Cap on Stage 1 candidates
RERANKER_BATCH_SIZE: int = 32  # Batch size for reranking inference
```

Add a comment block like the existing sections (e.g., "# GraphRAG Configuration (Feature 113)").
  </action>
  <verify>Run `poetry run python -c "from agent_brain_server.config.settings import Settings; s = Settings(); print(s.ENABLE_RERANKING, s.RERANKER_PROVIDER)"` to verify settings load correctly and default to False and "sentence-transformers".</verify>
  <done>Settings class includes all RERANKER_* fields with correct defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Add RerankerProviderType enum to base.py</name>
  <files>agent-brain-server/agent_brain_server/providers/base.py</files>
  <action>
Add a new enum after SummarizationProviderType:

```python
class RerankerProviderType(str, Enum):
    """Supported reranking providers."""

    SENTENCE_TRANSFORMERS = "sentence-transformers"
    OLLAMA = "ollama"
```

This follows the pattern of EmbeddingProviderType and SummarizationProviderType.
  </action>
  <verify>Run `poetry run python -c "from agent_brain_server.providers.base import RerankerProviderType; print(RerankerProviderType.SENTENCE_TRANSFORMERS.value)"` to verify the enum is importable and has correct values.</verify>
  <done>RerankerProviderType enum exists with SENTENCE_TRANSFORMERS and OLLAMA values.</done>
</task>

<task type="auto">
  <name>Task 3: Add RerankerConfig class to provider_config.py</name>
  <files>agent-brain-server/agent_brain_server/config/provider_config.py</files>
  <action>
1. Add RerankerProviderType to the imports from base.py:
   ```python
   from agent_brain_server.providers.base import (
       EmbeddingProviderType,
       SummarizationProviderType,
       RerankerProviderType,
   )
   ```

2. Add RerankerConfig class after SummarizationConfig:
   ```python
   class RerankerConfig(BaseModel):
       """Configuration for reranking provider."""

       provider: RerankerProviderType = Field(
           default=RerankerProviderType.SENTENCE_TRANSFORMERS,
           description="Reranking provider to use",
       )
       model: str = Field(
           default="cross-encoder/ms-marco-MiniLM-L-6-v2",
           description="Model name for reranking",
       )
       base_url: Optional[str] = Field(
           default=None,
           description="Custom base URL (for Ollama)",
       )
       params: dict[str, Any] = Field(
           default_factory=dict,
           description="Provider-specific parameters (batch_size, etc.)",
       )

       model_config = {"use_enum_values": True}

       @field_validator("provider", mode="before")
       @classmethod
       def validate_provider(cls, v: Any) -> RerankerProviderType:
           """Convert string to enum if needed."""
           if isinstance(v, str):
               return RerankerProviderType(v.lower())
           if isinstance(v, RerankerProviderType):
               return v
           return RerankerProviderType(v)

       def get_base_url(self) -> Optional[str]:
           """Get base URL with defaults for specific providers."""
           if self.base_url:
               return self.base_url
           if self.provider == RerankerProviderType.OLLAMA:
               return "http://localhost:11434"
           return None
   ```

3. Add reranker field to ProviderSettings:
   ```python
   class ProviderSettings(BaseModel):
       """Top-level provider configuration."""

       embedding: EmbeddingConfig = Field(...)
       summarization: SummarizationConfig = Field(...)
       reranker: RerankerConfig = Field(
           default_factory=RerankerConfig,
           description="Reranking provider configuration (optional)",
       )
   ```

4. Add reranker to the logging in load_provider_settings():
   ```python
   if settings.reranker:
       logger.info(
           f"Active reranker provider: {settings.reranker.provider} "
           f"(model: {settings.reranker.model})"
       )
   ```
  </action>
  <verify>Run `poetry run python -c "from agent_brain_server.config.provider_config import RerankerConfig, ProviderSettings; r = RerankerConfig(); print(r.provider, r.model); p = ProviderSettings(); print(p.reranker.provider)"` to verify the config loads with defaults.</verify>
  <done>RerankerConfig class exists, follows provider pattern, integrated into ProviderSettings.</done>
</task>

</tasks>

<verification>
1. All imports resolve without errors
2. Default values match research recommendations (sentence-transformers, cross-encoder/ms-marco-MiniLM-L-6-v2)
3. ENABLE_RERANKING defaults to False
4. Pattern matches existing EmbeddingConfig and SummarizationConfig
</verification>

<success_criteria>
- Settings class has ENABLE_RERANKING=False default
- RerankerProviderType enum has SENTENCE_TRANSFORMERS and OLLAMA
- RerankerConfig follows existing provider config pattern
- ProviderSettings includes optional reranker field
- All imports and types resolve correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-two-stage-reranking/01-01-SUMMARY.md`
</output>
