---
phase: 09-runtime-backend-wiring
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - agent-brain-server/tests/integration/test_backend_wiring.py
autonomous: true

must_haves:
  truths:
    - "Mock-based wiring test proves factory backend selection drives service backend type"
    - "Test verifies storage_backend parameter takes precedence over legacy constructor path"
    - "Test runs in task before-push without requiring PostgreSQL database"
    - "All existing tests pass alongside new wiring tests"
    - "task before-push exits with code 0"
  artifacts:
    - path: "agent-brain-server/tests/integration/test_backend_wiring.py"
      provides: "Backend wiring smoke tests"
      contains: "test_factory_backend_wired_to_services"
  key_links:
    - from: "agent-brain-server/tests/integration/test_backend_wiring.py"
      to: "agent_brain_server.storage.factory.get_storage_backend"
      via: "mock-based test calling factory"
      pattern: "get_storage_backend"
    - from: "agent-brain-server/tests/integration/test_backend_wiring.py"
      to: "QueryService and IndexingService constructors"
      via: "storage_backend parameter verification"
      pattern: "storage_backend=.*backend"
---

<objective>
Create mock-based wiring smoke tests that verify factory-selected backend drives service behavior, then run full quality gate to confirm zero regressions.

Purpose: Provide automated verification that the Phase 9 wiring changes work correctly and catch future regressions.
Output: New test file with backend wiring tests, clean `task before-push` run.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-runtime-backend-wiring/09-RESEARCH.md
@.planning/phases/09-runtime-backend-wiring/09-01-SUMMARY.md
@agent-brain-server/agent_brain_server/api/main.py
@agent-brain-server/agent_brain_server/storage/factory.py
@agent-brain-server/tests/integration/test_unified_search.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mock-based backend wiring smoke tests</name>
  <files>agent-brain-server/tests/integration/test_backend_wiring.py</files>
  <action>
Create `tests/integration/test_backend_wiring.py` with mock-based tests that verify the backend wiring logic. These tests MUST run without a PostgreSQL database (mock-based only) so they always execute in `task before-push`.

**Test structure:**

```python
"""Backend wiring smoke tests.

Verify that factory-selected storage backend drives service behavior.
These tests are mock-based and always run in task before-push
(no PostgreSQL database required).
"""

import pytest
from unittest.mock import patch, MagicMock

from agent_brain_server.storage.factory import (
    get_storage_backend,
    reset_storage_backend_cache,
)
from agent_brain_server.services.query_service import QueryService
from agent_brain_server.services.indexing_service import IndexingService
```

**Tests to implement (5 tests):**

1. `test_storage_backend_parameter_takes_precedence`:
   - Create a MagicMock backend
   - Pass it as `storage_backend=mock_backend` to QueryService and IndexingService
   - Assert `service.storage_backend is mock_backend` for both services
   - This confirms the new wiring path in main.py works

2. `test_legacy_params_still_wrap_in_chroma_backend`:
   - Create mock vector_store and mock bm25_manager
   - Pass them as legacy params to QueryService (vector_store=mock_vs, bm25_manager=mock_bm25)
   - Assert `isinstance(service.storage_backend, ChromaBackend)` (from `agent_brain_server.storage.chroma.backend`)
   - This confirms backward compat for existing tests

3. `test_chroma_factory_returns_chroma_backend`:
   - Call `reset_storage_backend_cache()`
   - Patch `agent_brain_server.storage.factory.get_effective_backend_type` to return "chroma"
   - Call `get_storage_backend()`
   - Assert `isinstance(backend, ChromaBackend)`
   - Pass to QueryService, assert service.storage_backend is the same instance

4. `test_postgres_factory_returns_postgres_backend`:
   - Call `reset_storage_backend_cache()`
   - Patch `agent_brain_server.storage.factory.get_effective_backend_type` to return "postgres"
   - Patch `agent_brain_server.storage.factory.PostgresBackend` (the lazy import) to return a MagicMock
   - Also patch `agent_brain_server.storage.factory.PostgresConfig` to return a MagicMock config
   - Also patch `agent_brain_server.storage.factory.load_provider_settings` to return a mock with storage.postgres dict
   - Call `get_storage_backend()`
   - Assert the returned backend is the mocked PostgresBackend instance
   - Pass to QueryService, assert service.storage_backend is the same instance

5. `test_graph_query_rejected_on_postgres_backend`:
   - Patch `get_effective_backend_type` to return "postgres"
   - Create QueryService with a mock storage_backend
   - Call `service._execute_graph_query(mock_request)` (or test the validation logic)
   - Assert it raises ValueError with message containing "require ChromaDB"

**Important implementation notes:**
- Use `reset_storage_backend_cache()` in a fixture or at the start of each test that calls `get_storage_backend()` to avoid singleton pollution between tests
- Use `@pytest.fixture(autouse=True)` with `reset_storage_backend_cache()` cleanup
- Keep tests synchronous where possible; use `@pytest.mark.asyncio` only for async methods
- All tests must be mock-based -- no real ChromaDB or PostgreSQL connections
- Follow existing test conventions: class-based test organization, use `MagicMock` for dependencies
- Ensure all imports are from the correct modules

**Add cleanup fixture:**
```python
@pytest.fixture(autouse=True)
def cleanup_backend_cache():
    """Reset backend cache between tests."""
    reset_storage_backend_cache()
    yield
    reset_storage_backend_cache()
```
  </action>
  <verify>
Run `cd /Users/richardhightower/clients/spillwave/src/agent-brain/agent-brain-server && poetry run pytest tests/integration/test_backend_wiring.py -v` to verify all 5 tests pass.
Run `cd /Users/richardhightower/clients/spillwave/src/agent-brain/agent-brain-server && poetry run ruff check tests/integration/test_backend_wiring.py` for lint.
Run `cd /Users/richardhightower/clients/spillwave/src/agent-brain/agent-brain-server && poetry run mypy tests/integration/test_backend_wiring.py --ignore-missing-imports` for type checking.
  </verify>
  <done>
5 mock-based wiring tests pass, covering: storage_backend precedence, legacy backward compat, chroma factory, postgres factory (mocked), graph query rejection on postgres. All tests run without PostgreSQL database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run task before-push to verify zero regressions</name>
  <files></files>
  <action>
Run the full quality gate to verify all existing tests pass alongside the new wiring tests:

```bash
cd /Users/richardhightower/clients/spillwave/src/agent-brain
task before-push
```

This runs:
1. `black` (formatting)
2. `ruff check` (linting)
3. `mypy` (type checking)
4. `pytest` (all tests with coverage)

**If any step fails:**
- Fix the issue in the relevant file
- Re-run `task before-push`
- Repeat until exit code 0

**Common issues to watch for:**
- Line too long (>88 chars) in new test file -- run `black` to fix
- Missing type stubs -- add `# type: ignore` comments if needed
- Import ordering -- run `ruff check --fix`
- Mock patching paths incorrect -- verify the full module path matches the import location

**Expected outcome:** All 650+ existing tests pass, plus 5 new wiring tests. Exit code 0.
  </action>
  <verify>
`task before-push` exits with code 0. No lint errors, no type errors, all tests pass. Coverage remains above 50%.
  </verify>
  <done>
task before-push passes with exit code 0. All existing tests pass (no regressions from main.py rewiring). All new wiring tests pass. Code is properly formatted, linted, and type-checked.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/richardhightower/clients/spillwave/src/agent-brain && task before-push` exits 0
2. `poetry run pytest tests/integration/test_backend_wiring.py -v` shows 5 tests passing
3. Total test count >= 655 (650+ existing + 5 new)
4. No `pytest.mark.postgres` on any of the new wiring tests (they must run without database)
</verification>

<success_criteria>
- 5 mock-based wiring tests exist and pass in tests/integration/test_backend_wiring.py
- Tests verify: storage_backend precedence, legacy backward compat, chroma factory, postgres factory, graph query rejection
- All tests are mock-based (no PostgreSQL required)
- task before-push passes with exit code 0
- Zero test regressions from Phase 9 changes
</success_criteria>

<output>
After completion, create `.planning/phases/09-runtime-backend-wiring/09-02-SUMMARY.md`
</output>
