---
phase: 09-runtime-backend-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agent-brain-server/agent_brain_server/api/main.py
  - agent-brain-server/agent_brain_server/services/query_service.py
  - agent-brain-server/agent_brain_server/api/routers/health.py
  - agent-brain-plugin/commands/agent-brain-graph.md
  - agent-brain-plugin/commands/agent-brain-multi.md
autonomous: true

must_haves:
  truths:
    - "When AGENT_BRAIN_STORAGE_BACKEND=postgres, services receive PostgresBackend instance (not ChromaBackend)"
    - "When AGENT_BRAIN_STORAGE_BACKEND=postgres, no ChromaDB directories or BM25 index directories are created"
    - "Graph queries (mode=graph, mode=multi) return clear error when backend is postgres"
    - "Health status endpoint shows graph_store as unavailable with reason when backend is postgres"
    - "Plugin documentation notes graph queries require ChromaDB backend"
  artifacts:
    - path: "agent-brain-server/agent_brain_server/api/main.py"
      provides: "Conditional ChromaDB initialization and storage_backend-driven service creation"
      contains: "storage_backend=storage_backend"
    - path: "agent-brain-server/agent_brain_server/services/query_service.py"
      provides: "Graph query validation for postgres backend"
      contains: "Graph queries.*require ChromaDB"
    - path: "agent-brain-server/agent_brain_server/api/routers/health.py"
      provides: "Graph store unavailable status on postgres backend"
      contains: "graph_store"
  key_links:
    - from: "agent-brain-server/agent_brain_server/api/main.py"
      to: "agent_brain_server.storage.factory.get_storage_backend"
      via: "factory call in lifespan"
      pattern: "storage_backend = get_storage_backend\\(\\)"
    - from: "agent-brain-server/agent_brain_server/api/main.py"
      to: "IndexingService and QueryService constructors"
      via: "storage_backend parameter"
      pattern: "storage_backend=storage_backend"
---

<objective>
Rewire main.py lifespan to pass factory-selected storage backend to services, conditionally skip ChromaDB/BM25 initialization when using postgres, add graph query validation for non-chroma backends, and update plugin docs.

Purpose: Close the v6.0 audit gap where factory selects the backend but services always use ChromaDB via legacy parameters.
Output: main.py passing storage_backend to services, conditional ChromaDB init, graph query guard, health endpoint graph status, plugin doc updates.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-runtime-backend-wiring/09-RESEARCH.md
@agent-brain-server/agent_brain_server/api/main.py
@agent-brain-server/agent_brain_server/services/query_service.py
@agent-brain-server/agent_brain_server/services/indexing_service.py
@agent-brain-server/agent_brain_server/storage/factory.py
@agent-brain-server/agent_brain_server/api/routers/health.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire main.py lifespan with conditional ChromaDB initialization</name>
  <files>agent-brain-server/agent_brain_server/api/main.py</files>
  <action>
Modify the `lifespan()` function in main.py to:

1. **Move backend type check early** (already exists at line 238): Use `get_effective_backend_type()` to determine backend type before any ChromaDB initialization.

2. **Conditional ChromaDB initialization**: Wrap the VectorStoreManager and BM25IndexManager creation in a `if backend_type == "chroma":` block. When backend is postgres, skip:
   - VectorStoreManager creation and initialization (lines 230-235)
   - BM25IndexManager creation and initialization (lines 256-261)
   - The `check_embedding_compatibility(vector_store)` call (lines 248-254) -- this uses VectorStoreManager directly and is ChromaDB-specific
   - Do NOT create chroma_dir or bm25_dir variables when backend is postgres

3. **Pass storage_backend to services instead of legacy params**: Change service creation (lines 281-293) from:
   ```python
   indexing_service = IndexingService(
       vector_store=vector_store,
       bm25_manager=bm25_manager,
       document_loader=document_loader,
   )
   query_service = QueryService(
       vector_store=vector_store,
       bm25_manager=bm25_manager,
   )
   ```
   To:
   ```python
   indexing_service = IndexingService(
       storage_backend=storage_backend,
       document_loader=document_loader,
   )
   query_service = QueryService(
       storage_backend=storage_backend,
   )
   ```

4. **Preserve app.state backward compat for ChromaDB path**: When backend is chroma, still set `app.state.vector_store` and `app.state.bm25_manager` for any code that reads them (e.g., health.py). When backend is postgres, set these to None or omit them, but create a sentinel so health.py can handle both cases. Use `app.state.vector_store = vector_store if backend_type == "chroma" else None` pattern.

5. **Store backend_type on app.state**: Set `app.state.backend_type = backend_type` for use by health endpoint and query routers.

6. **Keep the `check_embedding_compatibility` function unchanged** -- it's only called in the chroma branch.

7. **Important**: The `app.state.storage_backend = storage_backend` assignment already exists (line 244). Keep it where it is. The key change is: don't pass vector_store/bm25_manager to services, pass storage_backend instead.

8. **Cleanup unused import if needed**: After changes, `BM25IndexManager` import at line 32 may still be needed for type reference. Only remove if truly unused after refactor. The `check_embedding_compatibility` function signature still references `VectorStoreManager`, so keep that import too.
  </action>
  <verify>
Run `cd /Users/richardhightower/clients/spillwave/src/agent-brain/agent-brain-server && poetry run python -c "from agent_brain_server.api.main import app; print('main.py imports OK')"` to verify the module loads without import errors.
Run `cd /Users/richardhightower/clients/spillwave/src/agent-brain/agent-brain-server && poetry run ruff check agent_brain_server/api/main.py` to verify no lint errors.
Run `cd /Users/richardhightower/clients/spillwave/src/agent-brain/agent-brain-server && poetry run mypy agent_brain_server/api/main.py --ignore-missing-imports` to verify type checking passes.
  </verify>
  <done>
main.py lifespan conditionally initializes ChromaDB components only when backend_type is "chroma". Services receive storage_backend parameter from factory. No ChromaDB directories created when backend is postgres. app.state.backend_type is set. Module loads without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add graph query validation and health endpoint graph status for postgres backend</name>
  <files>
agent-brain-server/agent_brain_server/services/query_service.py
agent-brain-server/agent_brain_server/api/routers/health.py
  </files>
  <action>
**QueryService graph query validation** (`query_service.py`):

1. In `_execute_graph_query()` method, add a check BEFORE the existing `ENABLE_GRAPH_INDEX` check (around line 457):
   ```python
   # Check backend compatibility for graph queries
   backend_type = get_effective_backend_type()
   if backend_type != "chroma":
       raise ValueError(
           f"Graph queries (mode='graph') require ChromaDB backend. "
           f"Current backend: '{backend_type}'. "
           f"To use graph queries, set AGENT_BRAIN_STORAGE_BACKEND=chroma."
       )
   ```
   Import `get_effective_backend_type` from `agent_brain_server.storage` (already imported in query_service.py at line 27-32).

2. In `_execute_multi_query()` method, guard the graph results section (around line 558-563). Change:
   ```python
   graph_results: list[QueryResult] = []
   if settings.ENABLE_GRAPH_INDEX:
       try:
           graph_results = await self._execute_graph_query(request)
       except ValueError:
           pass  # Graph not enabled, skip
   ```
   To:
   ```python
   graph_results: list[QueryResult] = []
   backend_type = get_effective_backend_type()
   if settings.ENABLE_GRAPH_INDEX and backend_type == "chroma":
       try:
           graph_results = await self._execute_graph_query(request)
       except ValueError:
           pass  # Graph not enabled or not available, skip
   elif backend_type != "chroma":
       logger.info(
           "Graph component skipped in multi-mode: "
           "graph queries require ChromaDB backend "
           f"(current: {backend_type})"
       )
   ```
   This way multi-mode gracefully degrades on postgres (uses BM25 + vector only) while graph-only mode raises an explicit error.

3. The import for `get_effective_backend_type` is already present at line 27-32 (`from agent_brain_server.storage import ... get_effective_backend_type ...`). Verify this.

**Health endpoint graph status** (`health.py`):

4. In `indexing_status()` function, after getting `service_status` (line 154), add backend-aware graph status override:
   ```python
   # Override graph index status when on non-chroma backend
   backend_type = get_effective_backend_type()
   graph_index_info = service_status.get("graph_index")
   if backend_type != "chroma" and graph_index_info is not None:
       graph_index_info = {
           "enabled": False,
           "initialized": False,
           "entity_count": 0,
           "relationship_count": 0,
           "store_type": "unavailable",
           "reason": f"Graph queries require ChromaDB backend (current: {backend_type})",
       }
       service_status["graph_index"] = graph_index_info
   ```
   The `get_effective_backend_type` import already exists in health.py (line 18).

5. In `health_check()` function, the `vector_store = request.app.state.vector_store` line (line 43) will fail when backend is postgres (vector_store is None). Change to:
   ```python
   vector_store = getattr(request.app.state, "vector_store", None)
   ```
   And update the `elif not vector_store.is_initialized:` check (line 69) to:
   ```python
   elif vector_store is not None and not vector_store.is_initialized:
   ```
   Also handle the case when vector_store is None (postgres backend) -- treat as healthy if storage_backend is initialized:
   ```python
   elif vector_store is None:
       # Non-chroma backend -- check storage_backend directly
       storage_backend = getattr(request.app.state, "storage_backend", None)
       if storage_backend and storage_backend.is_initialized:
           status = "healthy"
           message = "Server is running and ready for queries"
       else:
           status = "degraded"
           message = "Storage backend not initialized"
   ```

6. In `indexing_status()` function, the `vector_store = request.app.state.vector_store` at line 117 needs the same fix:
   ```python
   vector_store = getattr(request.app.state, "vector_store", None)
   ```
   And the `total_chunks` calculation (lines 121-125) should use storage_backend when vector_store is None:
   ```python
   try:
       if vector_store is not None and vector_store.is_initialized:
           total_chunks = await vector_store.get_count()
       else:
           storage_backend = getattr(request.app.state, "storage_backend", None)
           if storage_backend and storage_backend.is_initialized:
               total_chunks = await storage_backend.get_count()
           else:
               total_chunks = 0
   except Exception:
       total_chunks = 0
   ```
  </action>
  <verify>
Run `cd /Users/richardhightower/clients/spillwave/src/agent-brain/agent-brain-server && poetry run ruff check agent_brain_server/services/query_service.py agent_brain_server/api/routers/health.py` to verify no lint errors.
Run `cd /Users/richardhightower/clients/spillwave/src/agent-brain/agent-brain-server && poetry run mypy agent_brain_server/services/query_service.py agent_brain_server/api/routers/health.py --ignore-missing-imports` to verify type checking.
  </verify>
  <done>
Graph queries raise ValueError with clear message when backend is postgres. Multi-mode gracefully skips graph component on postgres. Health endpoint shows graph_store as unavailable with reason on postgres. Health endpoints handle None vector_store safely for postgres backend.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update plugin documentation for graph query ChromaDB requirement</name>
  <files>
agent-brain-plugin/commands/agent-brain-graph.md
agent-brain-plugin/commands/agent-brain-multi.md
  </files>
  <action>
**agent-brain-graph.md**: Add a "Backend Requirements" section after the "Prerequisites" section:

```markdown
## Backend Requirements

Graph search is only available when using the **ChromaDB** storage backend (default). If you are using the PostgreSQL backend (`AGENT_BRAIN_STORAGE_BACKEND=postgres`), graph queries will return an error:

```
Error: Graph queries (mode='graph') require ChromaDB backend.
Current backend: 'postgres'.
To use graph queries, set AGENT_BRAIN_STORAGE_BACKEND=chroma.
```

To use graph search, switch to ChromaDB backend or use `/agent-brain-hybrid` for hybrid BM25 + vector search on any backend.
```

Also add to the "Error Handling" section a new subsection:

```markdown
### PostgreSQL Backend

```
Error: Graph queries require ChromaDB backend
```

**Resolution:**
Graph search is not supported on the PostgreSQL backend. Options:
- Switch to ChromaDB: `export AGENT_BRAIN_STORAGE_BACKEND=chroma`
- Use hybrid search instead: `agent-brain query "..." --mode hybrid`
```

**agent-brain-multi.md**: Update the "Graceful Degradation" table to include a postgres backend row:

Add after the existing table:

```markdown
**Note:** When using the PostgreSQL backend (`AGENT_BRAIN_STORAGE_BACKEND=postgres`), multi-mode automatically uses BM25 + Vector only (graph component is skipped). No error is raised -- multi-mode gracefully adapts.
```

Also update the "Graph Index Not Available" error section to mention postgres:

Add a note: "When using PostgreSQL backend, graph is automatically excluded from multi-mode results. No action needed."
  </action>
  <verify>
Visually inspect the two modified markdown files to confirm the new sections are properly formatted and placed. Run `wc -l agent-brain-plugin/commands/agent-brain-graph.md agent-brain-plugin/commands/agent-brain-multi.md` to confirm files were modified (line counts should increase).
  </verify>
  <done>
Plugin documentation for agent-brain-graph and agent-brain-multi commands includes clear notes that graph queries require ChromaDB backend, with postgres-specific error handling guidance. Multi-mode degradation behavior on postgres is documented.
  </done>
</task>

</tasks>

<verification>
1. `cd agent-brain-server && poetry run ruff check agent_brain_server/` -- no lint errors
2. `cd agent-brain-server && poetry run mypy agent_brain_server/ --ignore-missing-imports` -- no type errors
3. `cd agent-brain-server && poetry run black --check agent_brain_server/` -- formatting correct
4. `cd agent-brain-server && poetry run pytest tests/ -x --timeout=30 -q` -- all existing tests pass (services backward-compat constructors keep them working)
5. Verify main.py: `grep "storage_backend=storage_backend" agent_brain_server/api/main.py` returns hits for both IndexingService and QueryService
6. Verify main.py: `grep "vector_store=vector_store" agent_brain_server/api/main.py` returns NO hits in service construction (only in app.state assignment within chroma block)
</verification>

<success_criteria>
- main.py passes storage_backend to IndexingService and QueryService (not vector_store/bm25_manager)
- ChromaDB components only initialized when backend_type == "chroma"
- Graph queries raise ValueError on postgres backend with actionable message
- Multi-mode skips graph on postgres (no error, graceful degradation)
- Health endpoint shows graph as unavailable on postgres
- Health endpoints handle None vector_store for postgres backend
- Plugin docs updated with ChromaDB requirement for graph queries
- All existing tests still pass (backward-compatible constructors preserve test patterns)
</success_criteria>

<output>
After completion, create `.planning/phases/09-runtime-backend-wiring/09-01-SUMMARY.md`
</output>
