@startuml Server Stop Sequence
!theme plain
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

title CLI Server Stop Sequence

actor User
participant "agent-brain CLI" as CLI
participant "File System" as FS
participant "Process\nManager" as PM
participant "Global Registry" as Registry

== Project Resolution ==

User -> CLI : agent-brain stop [--force] [--path]
activate CLI

CLI -> CLI : Resolve project root\n(same as start)

CLI -> CLI : state_dir = project_root / ".claude/doc-serve"

== State Check ==

CLI -> FS : Check state_dir.exists()
activate FS
FS --> CLI : exists = true/false
deactivate FS

alt State dir doesn't exist
    CLI --> User : "No doc-serve state found"
    CLI -> CLI : exit(1)
end

== Runtime Check ==

CLI -> FS : Read runtime.json
activate FS
FS --> CLI : runtime dict or None
deactivate FS

alt runtime.json doesn't exist
    CLI -> FS : Check for stale PID file
    activate FS
    FS --> CLI : pid or None
    deactivate FS

    alt Stale PID found and alive
        CLI --> User : "Found stale PID, stopping..."
        CLI -> CLI : runtime = {pid: stale_pid}
    else No runtime state
        CLI -> FS : Cleanup any remaining files
        CLI --> User : "No server running"
        CLI -> CLI : return (success)
    end
end

CLI -> CLI : pid = runtime.pid

alt No PID in runtime
    CLI -> FS : Cleanup state files
    CLI --> User : "No server PID found"
    CLI -> CLI : return
end

== Process Check ==

CLI -> PM : Check is_process_alive(pid)\nos.kill(pid, 0)
activate PM

alt Process not alive
    PM --> CLI : ProcessLookupError
    deactivate PM

    CLI -> FS : Cleanup state files
    CLI -> Registry : Remove from registry
    CLI --> User : "Server already stopped (PID {pid})"
    CLI --> User : "Cleaned up state files"
    CLI -> CLI : return
else Process alive
    PM --> CLI : alive = true
end

== Graceful Shutdown ==

CLI --> User : "Stopping server (PID {pid})..."

CLI -> PM : os.kill(pid, SIGTERM)
activate PM
PM --> CLI : signal sent
deactivate PM

loop Wait for exit (timeout: 10s)
    CLI -> PM : Check is_process_alive(pid)
    activate PM

    alt Process exited
        PM --> CLI : not alive
        deactivate PM
        CLI -> CLI : break loop (success)
    else Still running
        PM --> CLI : alive
        deactivate PM
        CLI -> CLI : sleep(0.2)
    end
end

alt Graceful exit succeeded
    CLI -> FS : Delete runtime.json, lock, pid
    CLI -> Registry : Remove project from registry
    CLI --> User : "Server stopped gracefully (PID {pid})"
    CLI -> CLI : return

else Graceful timeout
    alt Force flag provided
        CLI --> User : "Graceful timeout, sending SIGKILL..."

        CLI -> PM : os.kill(pid, SIGKILL)
        activate PM
        PM --> CLI : SIGKILL sent
        deactivate PM

        loop Wait for SIGKILL (5s)
            CLI -> PM : Check is_process_alive(pid)
            activate PM

            alt Process killed
                PM --> CLI : not alive
                deactivate PM
                CLI -> CLI : break
            else Still running
                PM --> CLI : alive
                deactivate PM
                CLI -> CLI : sleep(0.2)
            end
        end

        alt SIGKILL succeeded
            CLI -> FS : Cleanup state files
            CLI -> Registry : Remove from registry
            CLI --> User : "Server force killed (PID {pid})"
        else SIGKILL failed
            CLI --> User : "Failed to stop server"
            CLI -> CLI : exit(1)
        end

    else No force flag
        CLI --> User : "Graceful shutdown timeout"
        CLI --> User : "Use --force to send SIGKILL"
        CLI -> CLI : exit(1)
    end
end

deactivate CLI

@enduml